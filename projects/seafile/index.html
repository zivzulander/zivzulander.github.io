<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[Matt Morris]"><meta name=description content="Updated on August 31, 2022 for Seafile Server 9.0.2 on Raspberry Pi Bullseye.
Seafile is a free and open source file syncing tool that can be self-hosted on a raspberry pi. While there are other tools you can use to sync your data, Seafile has a few advantages:
access data remotely over https send or share files and folders with other users or guests edit documents right in the browser simple WebDAV setup 2FA iOS clients data de-duplication multi-user support There is one well-known disadvantage: Files are stored in a proprietary format which can&amp;rsquo;t be accessed through a normal file browser."><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://mattmorris.ca/projects/seafile/><title>Install Seafile on a Raspberry Pi :: matt morris</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.4e5c639214707eff609bb55fe49e183dee42258a73bc90e4cc7b0a84f900798a.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Install Seafile on a Raspberry Pi"><meta itemprop=description content="Updated on August 31, 2022 for Seafile Server 9.0.2 on Raspberry Pi Bullseye.
Seafile is a free and open source file syncing tool that can be self-hosted on a raspberry pi. While there are other tools you can use to sync your data, Seafile has a few advantages:
access data remotely over https send or share files and folders with other users or guests edit documents right in the browser simple WebDAV setup 2FA iOS clients data de-duplication multi-user support There is one well-known disadvantage: Files are stored in a proprietary format which can&rsquo;t be accessed through a normal file browser."><meta itemprop=wordCount content="1471"><meta itemprop=image content="https://mattmorris.ca"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://mattmorris.ca"><meta name=twitter:title content="Install Seafile on a Raspberry Pi"><meta name=twitter:description content="Updated on August 31, 2022 for Seafile Server 9.0.2 on Raspberry Pi Bullseye.
Seafile is a free and open source file syncing tool that can be self-hosted on a raspberry pi. While there are other tools you can use to sync your data, Seafile has a few advantages:
access data remotely over https send or share files and folders with other users or guests edit documents right in the browser simple WebDAV setup 2FA iOS clients data de-duplication multi-user support There is one well-known disadvantage: Files are stored in a proprietary format which can&rsquo;t be accessed through a normal file browser."><meta property="og:title" content="Install Seafile on a Raspberry Pi"><meta property="og:description" content="Updated on August 31, 2022 for Seafile Server 9.0.2 on Raspberry Pi Bullseye.
Seafile is a free and open source file syncing tool that can be self-hosted on a raspberry pi. While there are other tools you can use to sync your data, Seafile has a few advantages:
access data remotely over https send or share files and folders with other users or guests edit documents right in the browser simple WebDAV setup 2FA iOS clients data de-duplication multi-user support There is one well-known disadvantage: Files are stored in a proprietary format which can&rsquo;t be accessed through a normal file browser."><meta property="og:type" content="article"><meta property="og:url" content="https://mattmorris.ca/projects/seafile/"><meta property="og:image" content="https://mattmorris.ca"><meta property="article:section" content="projects"><meta property="og:site_name" content="matt morris"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__text>matt morris</span></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about>about</a></li><li><a href=/music>music</a></li><li><a href=/contact>contact</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://mattmorris.ca/projects/seafile/>Install Seafile on a Raspberry Pi</a></h2><div class=post-content><p><em>Updated on August 31, 2022 for <a href=https://github.com/haiwen/seafile-rpi>Seafile Server 9.0.2</a> on Raspberry Pi Bullseye.</em></p><p><a href=https://www.seafile.com/en/home/>Seafile</a> is a free and open source file syncing tool that can be self-hosted on a raspberry pi. While there are other tools you can use to sync your data, Seafile has a few advantages:</p><ul><li>access data remotely over https</li><li>send or share files and folders with other users or guests</li><li>edit documents right in the browser</li><li>simple WebDAV setup</li><li>2FA</li><li>iOS clients</li><li>data de-duplication</li><li>multi-user support</li></ul><p>There is one well-known disadvantage: Files are stored in a proprietary format which can&rsquo;t be accessed through a normal file browser. You have to either mount it or run a <a href=https://manual.seafile.com/maintain/seafile_fsck/>script</a> to convert the data.</p><p>You could hack together your own server with <a href=https://syncthing.net/>Syncthing</a>, <a href=https://rclone.org/commands/rclone_mount/>rclone mount</a>, <a href=https://nginx.org/en/docs/http/ngx_http_dav_module.html>nginx WebDAV</a>, etc., but it will probably be a lot more trouble.</p><p>We&rsquo;ll be installing <strong>Seafile</strong> on a Raspberry Pi 4 and setting up a reverse proxy so we can connect to it remotely though our own domain. There are instructions on <a href=https://manual.seafile.com/deploy/>Seafile&rsquo;s website</a> but the script and docker image don&rsquo;t seem to work on with the pi build at this time. We&rsquo;ll be installing it manually.</p><h2 id=getting-started>Getting started</h2><p><a href=/projects/setup_pi/>Setup your pi</a> with 64-bit <strong>Raspberry Pi OS</strong>.</p><h2 id=setting-up-your-own-domain>Setting up your own domain</h2><p>For security we&rsquo;re only going to access seafile though https. You&rsquo;ll need your own domain. I use <a href=https://www.namesilo.com/>Namesilo</a> but there are many options. A domain such as YOURDOMAIN.XYZ is about $1/year. You can even use the same address&rsquo;s subdomains for other applications such as bitwarden.YOURDOMAIN.XYZ.</p><p>Once you have this you need to point dns records to your public ip. How this is done is a little different for each site but there should be an option to manage dns where you can add an <code>a record</code> pointing to your <a href=https://whatismyipaddress.com/>public ipv4 address</a> and a <code>aaaa record</code> pointing to your ipv6 address. Something like this:</p><table><thead><tr><th>type</th><th>domain</th><th>data</th><th>ttl</th></tr></thead><tbody><tr><td>a</td><td></td><td>12.34.56.78</td><td>1 hour</td></tr><tr><td>aaaa</td><td></td><td>1234:5a78:b90:c123::d4e5</td><td>1 hour</td></tr></tbody></table><p>If you leave the <em>domain</em> (sometimes called <em>hostname</em>) blank then this will point to <em>YOURDOMAIN.XYZ</em>. If you add a domain like <em>seafile</em> then your seafile will be on <em>seafile.YOURDOMAIN.XYZ</em>. Whichever you choose is up to you.</p><table><thead><tr><th>type</th><th>domain</th><th>data</th><th>ttl</th></tr></thead><tbody><tr><td>a</td><td>seafile</td><td>12.34.56.78</td><td>1 hour</td></tr><tr><td>aaaa</td><td>seafile</td><td>1234:5a78:b90:c123::d4e5</td><td>1 hour</td></tr></tbody></table><p>It can take a few minutes to an hour for your dns server to refresh which is why we&rsquo;re doing this step first. You can run <code>ping -c1 seafile.YOURDOMAIN.XYZ</code> to see if the ip matches your home ip address.</p><h2 id=installing-prerequisites>Installing prerequisites</h2><p>Update your pi if you didn&rsquo;t already.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update <span style=color:#ff79c6>&amp;&amp;</span> sudo apt upgrade -y
</span></span></code></pre></div><p>Since we are going to be exposing this server the internet, we should make sure security updates are installed automatically.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install unattended-upgrades -y
</span></span></code></pre></div><p>Install dependencies for <code>mysql</code> as well as a few other tools we&rsquo;ll be using.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install -y python3 python3-setuptools python3-pip default-libmysqlclient-dev python3-pymysql memcached libmemcached-dev libffi-dev python3-certbot-nginx/stable nginx fail2ban
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo pip3 install --timeout<span style=color:#ff79c6>=</span><span style=color:#bd93f9>3600</span> <span style=color:#8be9fd;font-style:italic>django</span><span style=color:#ff79c6>==</span>3.2.* pillow pylibmc captcha jinja2 <span style=color:#8be9fd;font-style:italic>sqlalchemy</span><span style=color:#ff79c6>==</span>1.4.3 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    django-pylibmc django-simple-captcha python3-ldap mysqlclient <span style=color:#8be9fd;font-style:italic>pycryptodome</span><span style=color:#ff79c6>==</span>3.12.0 <span style=color:#8be9fd;font-style:italic>cffi</span><span style=color:#ff79c6>==</span>1.14.0 lxml pymysql
</span></span></code></pre></div><p>Set a mysql root password which you&rsquo;ll be asked for later. You can just press enter on the other questions to accept the default response.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mysql_secure_installation
</span></span></code></pre></div><h2 id=download-seafile>Download seafile</h2><p>Make a directory where Seafile and all your data will installed. e.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /mnt/usb/seafile
</span></span></code></pre></div><p>Download the Seafile scripts.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget -qo- <span style=color:#f1fa8c>&#34;https://github.com/haiwen/seafile-rpi/releases/download/v9.0.2/seafile-server-9.0.2-bullseye-arm64v8l.tar.gz&#34;</span> | tar xvz -c /mnt/usb/seafile
</span></span></code></pre></div><h2 id=install-seafile>Install Seafile</h2><p>Run the installation script.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/mnt/usb/seafile/setup-seafile-mysql.sh
</span></span></code></pre></div><p>Choose <code>[1] create new ccnet/seafile/seahub databases</code>. Most of the questions have a default answer which is a good idea to use. Just hit enter on those. Use the root password from when you typed <code>sudo mysql_secure_installation</code>.</p><h2 id=forward-ports-on-your-router>Forward ports on your router</h2><p>We&rsquo;re using a reverse proxy with <code>certbot</code> so we forward port 80 and 443 on your router to your Raspberry Pi&rsquo;s local ip.</p><h2 id=configuring-seafile>Configuring Seafile</h2><p>Some config files need to be changed since we&rsquo;ll be accessing Seafile from our custom domain through https.</p><h3 id=ccnet-dot-conf>ccnet.conf</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano /opt/seafile/conf/ccnet.conf
</span></span></code></pre></div><p>Change <code>service_url</code> to your domain. e.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>service_url</span> <span style=color:#ff79c6>=</span> https://YOURDOMAIN.XYZ
</span></span></code></pre></div><h3 id=seahub-settings-dot-py>seahub_settings.py</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano /opt/seafile/conf/seahub_settings.py
</span></span></code></pre></div><p>Change/add <code>file_server_root</code> to your domain and change your timezone (you can look for yours <a href=https://en.wikipedia.org/wiki/List_of_tz_database_time_zones>here</a>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>file_server_root</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;https://YOURDOMAIN.XYZ/seafhttp&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>timezone</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;America/Denver&#39;</span>
</span></span></code></pre></div><h3 id=seafdav-dot-conf>seafdav.conf</h3><p>If you want WebDAV (note that you cannot use with 2FA) then change <code>enabled</code> to <code>true</code> and change the location of the folder with <code>share_name = /seafdav</code>. This will give you a working WebDAV server which is more widely available for syncing with apps. You can access this through <a href=https://yourdomain.xyz/seafdav>https://yourdomain.xyz/seafdav</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nano /opt/seafile/conf/seafdav.conf
</span></span></code></pre></div><h2 id=reverse-proxy>Reverse Proxy</h2><p>This forwards requests from <a href=https://yourdomain.xyz>https://yourdomain.xyz</a> to wherever Seafile is running. In our case, <a href=http://127.0.0.1:8000>http://127.0.0.1:8000</a>.</p><h3 id=https-certificate-from-letsencrypt>HTTPS certificate from <a href=https://letsencrypt.org/>letsencrypt</a></h3><p>Change YOURDOMAIN.XYZ to your domain. It will place the files in <code>/etc/letsencrypt/live/YOURDOMAIN.XYZ/</code>. Remember that port 80 must be open for validation and that no other web server can be running.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo certbot certonly --nginx --domain YOURDOMAIN.XYZ
</span></span></code></pre></div><h3 id=configuring-nginx>Configuring <code>nginx</code></h3><p>First things first.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo rm /etc/nginx/sites-<span style=color:#ff79c6>{</span>enabled,available<span style=color:#ff79c6>}</span>/default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>touch /etc/nginx/sites-available/seafile.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo ln -s /etc/nginx/sites-available/seafile.conf /etc/nginx/sites-enabled/seafile.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo -e /etc/nginx/sites-available/seafile.conf
</span></span></code></pre></div><p>This can be the trickiest part if it&rsquo;s new to you. Copy the example below which is pieced together from <a href=https://manual.seafile.com/deploy/https_with_nginx/#modifying-nginx-configuration-file>Seafile&rsquo;s website</a> and adjust appropriately.</p><p>Here are some things to watch out for:</p><ul><li>Replace <em>YOURDOMAIN.XYZ</em> with your domain</li><li>Change <code>root = /mnt/usb/seafile/seafile-server-latest/seahub;</code> in <code>location /media</code> to where you&rsquo;ll store all your files.</li><li>This example contains a WebDAV config under <code>location /seafdav</code> so you can remove those lines if you aren&rsquo;t using it.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>log_format</span> <span style=color:#f1fa8c>seafileformat</span> <span style=color:#f1fa8c>&#39;</span><span style=color:#8be9fd;font-style:italic>$http_x_forwarded_for</span> <span style=color:#8be9fd;font-style:italic>$remote_addr</span> <span style=color:#f1fa8c>[</span><span style=color:#8be9fd;font-style:italic>$time_local]</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$request&#34;</span> <span style=color:#8be9fd;font-style:italic>$status</span> <span style=color:#8be9fd;font-style:italic>$body_bytes_sent</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$http_referer&#34;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$http_user_agent&#34;</span> <span style=color:#8be9fd;font-style:italic>$upstream_response_time&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>listen</span>       <span style=color:#bd93f9>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>server_name</span>  <span style=color:#f1fa8c>YOURDOMAIN.XYZ</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>rewrite</span> <span style=color:#f1fa8c>^</span> <span style=color:#f1fa8c>https://</span><span style=color:#8be9fd;font-style:italic>$http_host$request_uri?</span> <span style=color:#f1fa8c>permanent</span>;    <span style=color:#6272a4># Forced redirect from HTTP to HTTPS
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>server_tokens</span> off;      <span style=color:#6272a4># Prevents the Nginx version from being displayed in the HTTP response header
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>}
</span></span><span style=display:flex><span><span style=color:#ff79c6>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>listen</span> <span style=color:#bd93f9>443</span> <span style=color:#f1fa8c>ssl</span> <span style=color:#f1fa8c>http2</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>listen</span> <span style=color:#f1fa8c>[::]:443</span> <span style=color:#f1fa8c>ssl</span> <span style=color:#f1fa8c>http2</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>ssl_certificate</span> <span style=color:#f1fa8c>/etc/letsencrypt/live/YOURDOMAIN.XYZ/fullchain.pem</span>;    <span style=color:#6272a4># Path to your fullchain.pem
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>ssl_certificate_key</span> <span style=color:#f1fa8c>/etc/letsencrypt/live/YOURDOMAIN.XYZ/privkey.pem</span>;  <span style=color:#6272a4># Path to your privkey.pem
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>server_name</span> <span style=color:#f1fa8c>YOURDOMAIN.XYZ</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>server_tokens</span> off;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>location</span> <span style=color:#f1fa8c>/</span> {
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>proxy_pass</span>         <span style=color:#f1fa8c>http://127.0.0.1:8000</span>;
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>proxy_set_header</span>   <span style=color:#f1fa8c>Host</span> <span style=color:#8be9fd;font-style:italic>$host</span>;
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>proxy_set_header</span>   <span style=color:#f1fa8c>X-Real-IP</span> <span style=color:#8be9fd;font-style:italic>$remote_addr</span>;
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>proxy_set_header</span>   <span style=color:#f1fa8c>X-Forwarded-For</span> <span style=color:#8be9fd;font-style:italic>$proxy_add_x_forwarded_for</span>;
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>proxy_set_header</span>   <span style=color:#f1fa8c>X-Forwarded-Host</span> <span style=color:#8be9fd;font-style:italic>$server_name</span>;
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>proxy_read_timeout</span>  <span style=color:#f1fa8c>1200s</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#6272a4># used for view/edit office file via Office Online Server
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>         <span style=color:#ff79c6>client_max_body_size</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>access_log</span>      <span style=color:#f1fa8c>/var/log/nginx/seahub.access.log</span> <span style=color:#f1fa8c>seafileformat</span>;
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>error_log</span>       <span style=color:#f1fa8c>/var/log/nginx/seahub.error.log</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>location</span> <span style=color:#f1fa8c>/seafhttp</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>rewrite</span> <span style=color:#f1fa8c>^/seafhttp(.*)</span>$ <span style=color:#8be9fd;font-style:italic>$1</span> <span style=color:#f1fa8c>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>proxy_pass</span> <span style=color:#f1fa8c>http://127.0.0.1:8082</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>client_max_body_size</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>proxy_set_header</span>   <span style=color:#f1fa8c>X-Forwarded-For</span> <span style=color:#8be9fd;font-style:italic>$proxy_add_x_forwarded_for</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>proxy_connect_timeout</span>  <span style=color:#f1fa8c>36000s</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>proxy_read_timeout</span>  <span style=color:#f1fa8c>36000s</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>proxy_send_timeout</span>  <span style=color:#f1fa8c>36000s</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>proxy_request_buffering</span> off; <span style=color:#6272a4># enables large file uploads
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>send_timeout</span>  <span style=color:#f1fa8c>36000s</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>access_log</span>      <span style=color:#f1fa8c>/var/log/nginx/seafhttp.access.log</span> <span style=color:#f1fa8c>seafileformat</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>error_log</span>       <span style=color:#f1fa8c>/var/log/nginx/seafhttp.error.log</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>location</span> <span style=color:#f1fa8c>/seafdav</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>client_max_body_size</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>proxy_connect_timeout</span>  <span style=color:#f1fa8c>36000s</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>proxy_read_timeout</span>  <span style=color:#f1fa8c>36000s</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>proxy_send_timeout</span>  <span style=color:#f1fa8c>36000s</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>send_timeout</span>  <span style=color:#f1fa8c>36000s</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>proxy_request_buffering</span> off;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>access_log</span>      <span style=color:#f1fa8c>/var/log/nginx/seafdav.access.log</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>error_log</span>       <span style=color:#f1fa8c>/var/log/nginx/seafdav.error.log</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>location</span> <span style=color:#f1fa8c>/media</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>root</span> <span style=color:#f1fa8c>/mnt/usb/seafile/seafile-server-latest/seahub</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Test that the configuration works</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nginx -t
</span></span></code></pre></div><p>Start <code>nginx.</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl <span style=color:#8be9fd;font-style:italic>enable</span> --now nginx
</span></span></code></pre></div><h2 id=starting-seafile>Starting Seafile</h2><p>We want Seafile to start on boot. Create these 2 systemd unit files.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo -e /etc/systemd/system/seafile.service
</span></span></code></pre></div><p>Paste in the following (change directories if necessary):</p><p><strong>change user</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>Unit<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Description</span><span style=color:#ff79c6>=</span>Seafile
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>After</span><span style=color:#ff79c6>=</span>network.target mysql.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>Service<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Type</span><span style=color:#ff79c6>=</span>forking
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>ExecStart</span><span style=color:#ff79c6>=</span>/mnt/usb/seafile/seafile-server-latest/seafile.sh start
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>ExecStop</span><span style=color:#ff79c6>=</span>/mnt/usb/seafile/seafile-server-latest/seafile.sh stop
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>LimitNOFILE</span><span style=color:#ff79c6>=</span>infinity
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>User</span><span style=color:#ff79c6>=</span>seafile
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Group</span><span style=color:#ff79c6>=</span>seafile
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>Install<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>WantedBy</span><span style=color:#ff79c6>=</span>multi-user.target
</span></span></code></pre></div><p>And</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo -e /etc/systemd/system/seahub.service
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>Unit<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Description</span><span style=color:#ff79c6>=</span>Seafile hub
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>After</span><span style=color:#ff79c6>=</span>network.target seafile.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>Service<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Environment</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;LC_ALL=C&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Type</span><span style=color:#ff79c6>=</span>forking
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>ExecStart</span><span style=color:#ff79c6>=</span>/mnt/usb/seafile/seafile-server-latest/seahub.sh start
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>ExecStop</span><span style=color:#ff79c6>=</span>/mnt/usb/seafile/seafile-server-latest/seahub.sh stop
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>User</span><span style=color:#ff79c6>=</span>seafile
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Group</span><span style=color:#ff79c6>=</span>seafile
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>Install<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>WantedBy</span><span style=color:#ff79c6>=</span>multi-user.target
</span></span></code></pre></div><h3 id=start-and-enable-seafile>Start and enable Seafile</h3><p>have to run seahub first</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl <span style=color:#8be9fd;font-style:italic>enable</span> --now seafile seahub
</span></span></code></pre></div><p>You should now be able to access Seafile from the https domain. Login with the username and password you provided to the <code>./setup-seafile-mysql.sh</code> script.</p><h2 id=extra-stuff>Extra Stuff</h2><h3 id=enable-fail2ban>Enable Fail2Ban</h3><p><a href=https://manual.seafile.com/security/fail2ban/>Read more here.</a></p><p>Make sure you added your timezone when changing <a href=#seahub-settings-dot-py>seahub_settings.py</a></p><p>Backup then edit the <code>jail.local</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp /etc/fail2ban/jail.<span style=color:#ff79c6>{</span>conf,local<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>sudo -e /etc/fail2ban/jail.local
</span></span></code></pre></div><p>Add the following at the bottom (change the logpath if needed).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>seafile<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>enabled</span>  <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>port</span>     <span style=color:#ff79c6>=</span> http,https
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>filter</span>   <span style=color:#ff79c6>=</span> seafile-auth
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>logpath</span>  <span style=color:#ff79c6>=</span> /mnt/usb/seafile/logs/seahub.log
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>maxretry</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>3</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo -e /etc/fail2ban/filter.d/seafile-auth.conf
</span></span></code></pre></div><p>Add the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># Fail2Ban filter for seafile</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INCLUDES<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Read common prefixes. If any customizations available -- read them from</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># common.local</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>before</span> <span style=color:#ff79c6>=</span> common.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>Definition<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>_daemon</span> <span style=color:#ff79c6>=</span> seaf-server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>failregex</span> <span style=color:#ff79c6>=</span> Login attempt limit reached.*, ip: &lt;HOST&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>ignoreregex</span> <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># DEV Notes:</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># pattern :     2015-10-20 15:20:32,402 [WARNING] seahub.auth.views:155 login Login attempt limit reached, username: &lt;user&gt;, ip: 1.2.3.4, attemps: 3</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#       2015-10-20 17:04:32,235 [WARNING] seahub.auth.views:163 login Login attempt limit reached, ip: 1.2.3.4, attempts: 3</span>
</span></span></code></pre></div><p>Restart <code>fail2ban</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo fail2ban-client reload
</span></span></code></pre></div><h3 id=automated-garbage-collection>Automated Garbage Collection</h3><p>(Emptying the trash)</p><p>We&rsquo;ll have to write a little script for this since we want to automate it and it requires a few steps.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo -e /usr/local/bin/cleanup_seafile
</span></span></code></pre></div><p>Paste in the following. Change the path to Seafile if necessary.
<strong>need seafile user stuff and sudo?</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#6272a4># stop the server</span>
</span></span><span style=display:flex><span>systemctl stop seafile seahub
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sleep <span style=color:#bd93f9>20</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo -u seafile /mnt/usb/seafile/seafile-server-latest/seaf-gc.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sleep <span style=color:#bd93f9>60</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># start the server</span>
</span></span><span style=display:flex><span>systemctl start seafile seahub
</span></span></code></pre></div><p>Make this file executable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo chmod +x /usr/local/bin/cleanup_seafile
</span></span></code></pre></div><p>We&rsquo;ll use <code>crontab</code> to automate running this script.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>crontab -e
</span></span></code></pre></div><p>For example, to have it run at 4am on the first of each month. See <a href=https://crontab.guru/>here</a> for other options.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#bd93f9>0</span> <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>1</span> * *  sudo /usr/local/bin/cleanup_seafile
</span></span></code></pre></div><h3 id=enable-two-factor-authentication>Enable Two Factor Authentication</h3><p><strong>NOTE: Does not work with WebDAV</strong></p><p>Click on your avatar and got to <em>System Admin > Settings</em>.</p><p>Check the box titled <code>Enable two factor authentication</code>.</p><h3 id=add-more-users>Add more users</h3><p>Click on your avatar and got to <em>System Admin > Users</em>.</p></div></article><hr><div class=post-info></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.cf7fb2a9e24608a783e05e4472da2fdf008293289de1ad88d1cba5c143e7e414496dd33b6a228e92f8461ce0c8cbad3c9f9847e73e46dfbce0463393ddd1733a.js integrity="sha512-z3+yqeJGCKeD4F5Ectov3wCCkyid4a2I0culwUPn5BRJbdM7aiKOkvhGHODIy608n5hH5z5G37zgRjOT3dFzOg=="></script></body></html>